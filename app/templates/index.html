<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram é‡‡é›†ç®¡ç†å°</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <!-- ç™»å½•ç•Œé¢ -->
  <div id="login-container" class="login-container">
    <div class="login-card">
      <h2>ç™»å½•éªŒè¯</h2>
      <form id="login-form">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input type="password" id="password" name="password" required>
        </div>
        <button type="submit">ç™»å½•</button>
      </form>
      <div id="login-error" class="error-message" style="display: none;"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main-container" class="container" style="display: none;">
    <div class="header">
      <h1>Telegram é‡‡é›†ç®¡ç†å°</h1>
      <button id="logout-btn" class="logout-btn">é€€å‡ºç™»å½•</button>
    </div>

    {% if not settings.api_id or not settings.api_hash %}
    <div class="card" style="border-color:#e65c5c">
      <div class="row"><strong>ç¯å¢ƒæœªé…ç½®ï¼šç¼ºå°‘ API_ID / API_HASH</strong></div>
      <div class="row">è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>.env</code> å¹¶å¡«å…¥ <code>API_ID</code> ä¸ <code>API_HASH</code>ï¼Œç„¶åé‡å¯æœåŠ¡ã€‚</div>
    </div>
    {% else %}
    <div class="card" style="border-color:#4caf50">
      <div class="row"><strong>ç¯å¢ƒå·²å°±ç»ª</strong><span>ï¼ˆAPI_ID / API_HASH å·²é…ç½®ï¼‰</span></div>
    </div>
    {% endif %}

    <section>
      <h2>é‡‡é›†ç»Ÿè®¡</h2>
      <div class="card">
        <div class="row">
          <button onclick="loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
        </div>
        <div id="stats_content">
          <div class="row">ç‚¹å‡»"åˆ·æ–°ç»Ÿè®¡"æŸ¥çœ‹é‡‡é›†æ•°æ®</div>
        </div>
      </div>
    </section>

    <section>
      <h2>é‡‡é›†å†å²</h2>
      <div class="card">
        <div class="row">
          <button onclick="loadCollectionHistory()">åˆ·æ–°å†å²è®°å½•</button>
          <button onclick="clearCollectionHistory()" style="background:#e65c5c">æ¸…ç©ºå†å²</button>
        </div>
        <div id="collection_history"></div>
      </div>
    </section>

    <section>
      <h2>æ–°å¢è´¦å·</h2>
      <div class="card">
        <label>åç§°</label>
        <input id="acc_name" placeholder="å¦‚ï¼šç›‘å¬1å·" />
        <label>ç”µè¯ï¼ˆå¯é€‰ï¼‰</label>
        <input id="acc_phone" placeholder="+855..." />
        <label>StringSession</label>
        <textarea id="acc_session" placeholder="è‹¥æ²¡æœ‰ä¼šè¯ï¼Œä½¿ç”¨ä¸‹æ–¹ä¸€é”®ç”Ÿæˆ"></textarea>
        <label><input type="checkbox" id="acc_enabled" checked /> å¯ç”¨</label>
        <button onclick="createAccount()">æ–°å¢è´¦å·</button>

        <hr />
        <div class="row"><strong>æ²¡æœ‰ä¼šè¯ï¼Ÿç”¨æ‰‹æœºå·ä¸€é”®ç”Ÿæˆ</strong></div>
        <label>æ‰‹æœºå·ï¼ˆå«å›½å®¶ç ï¼Œå¦‚ +86...ï¼‰</label>
        <input id="gen_phone" placeholder="+86..." />
        <div class="row">
          <button onclick="sendCode()">å‘é€éªŒè¯ç </button>
        </div>
        <label>çŸ­ä¿¡/Telegram éªŒè¯ç </label>
        <input id="gen_code" placeholder="è¾“å…¥æ”¶åˆ°çš„ 5 ä½æˆ– 6 ä½éªŒè¯ç " />
        <label>ä¸¤æ­¥éªŒè¯å¯†ç ï¼ˆè‹¥å¼€å¯ï¼‰</label>
        <input id="gen_password" type="password" placeholder="å¯ç•™ç©º" />
        <div class="row">
          <button onclick="verifyLogin()">ç¡®è®¤ç™»å½•å¹¶ç”Ÿæˆä¼šè¯</button>
        </div>
        <div id="gen_msg" class="row" style="color:#666"></div>
      </div>
    </section>

    <section>
      <h2>è´¦å·åˆ—è¡¨</h2>
      <div class="card">
        <div class="row">
          <label>å…¨å±€é‡‡é›†å¤©æ•°</label>
          <input id="days_all" type="number" value="7" min="1" max="30" />
          <button id="collect_all_btn" onclick="collectAllEnabled()">é‡‡é›†æ‰€æœ‰å¯ç”¨è´¦å·</button>
          <div id="status_all" class="status-indicator idle" style="display: none;">
            <div class="status-dot"></div>
            <span>ç©ºé—²</span>
          </div>
        </div>
        <div id="progress_all" class="progress-container" style="display: none;">
          <div class="progress-bar-wrapper">
            <div class="progress-bar animated" style="width: 0%"></div>
          </div>
          <div class="progress-text">
            <span class="progress-percentage">0%</span>
            <span class="progress-details">
              <span class="current-group">å‡†å¤‡ä¸­...</span>
              <span class="eta" style="margin-left: 10px;">é¢„è®¡å‰©ä½™: --</span>
            </span>
          </div>
        </div>
        <div id="result_all"></div>
        <div class="row">
          <label>å…¨å±€å¯¼å‡ºèŒƒå›´</label>
          <select id="range_all">
            <option value="today">today</option>
            <option value="yesterday">yesterday</option>
            <option value="3d">3d</option>
            <option value="7d" selected>7d</option>
          </select>
          <input id="chat_all" placeholder="å¯é€‰ chat_id" />
          <a href="#" onclick="downloadTxtAll(); return false;">å¯¼å‡ºæ‰€æœ‰å¯ç”¨è´¦å· TXT</a>
        </div>
        <div class="row">
          <label>æ•°æ®åº“ç®¡ç†</label>
          <button onclick="cleanupDatabase()" style="background:#ff9800;">æ•´ç†æ•°æ®åº“</button>
          <button onclick="downloadCleanedUsernames()" style="background:#4caf50;">ä¸‹è½½æ•´ç†åç”¨æˆ·å</button>
        </div>
      </div>
      <div id="accounts"></div>
    </section>
  </div>

  <script>
    async function apiJSON(url, options = {}) {
      try {
        // ä¸ºé‡‡é›†è¯·æ±‚è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
        const isCollectRequest = url.includes('/api/collect');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!isCollectRequest) {
            controller.abort();
          }
        }, isCollectRequest ? 30 * 60 * 1000 : 30000); // é‡‡é›†è¯·æ±‚30åˆ†é’Ÿè¶…æ—¶ï¼Œå…¶ä»–è¯·æ±‚30ç§’
        
        const fetchOptions = {
          ...options,
          signal: controller.signal
        };
        
        const res = await fetch(url, fetchOptions);
        clearTimeout(timeoutId);
        
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const j = await res.json();
          return j;
        }
        const text = await res.text();
        return { ok: res.ok, data: null, error: text || res.statusText };
      } catch (e) {
        if (e.name === 'AbortError') {
          return { ok: false, data: null, error: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•' };
        }
        return { ok: false, data: null, error: e.message || String(e) };
      }
    }

    async function createAccount() {
      const name = document.getElementById('acc_name').value.trim();
      const phone = document.getElementById('acc_phone').value.trim();
      const session_string = document.getElementById('acc_session').value.trim();
      const is_enabled = document.getElementById('acc_enabled').checked;
      const j = await apiJSON('/api/accounts', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, phone, session_string, is_enabled})
      });
      alert(j.ok ? 'åˆ›å»ºæˆåŠŸ' : 'åˆ›å»ºå¤±è´¥: ' + j.error);
      if (j.ok) {
        document.getElementById('acc_name').value = '';
        document.getElementById('acc_phone').value = '';
        document.getElementById('acc_session').value = '';
        document.getElementById('acc_enabled').checked = true;
      }
      await loadAccounts();
    }

    async function sendCode() {
      const phone = document.getElementById('gen_phone').value.trim();
      if (!phone) { document.getElementById('gen_msg').textContent = 'è¯·å…ˆå¡«å†™æ‰‹æœºå·'; return; }
      document.getElementById('gen_msg').textContent = 'æ­£åœ¨å‘é€éªŒè¯ç ...';
      const j = await apiJSON('/api/session/init', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone })
      });
      document.getElementById('gen_msg').textContent = j.ok ? 'éªŒè¯ç å·²å‘é€ï¼Œè¯·è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç ' : ('å‘é€å¤±è´¥: ' + j.error);
    }

    async function verifyLogin() {
      const phone = document.getElementById('gen_phone').value.trim();
      const code = document.getElementById('gen_code').value.trim();
      const password = document.getElementById('gen_password').value.trim();
      if (!phone || !code) { document.getElementById('gen_msg').textContent = 'è¯·å¡«å†™æ‰‹æœºå·å’ŒéªŒè¯ç '; return; }
      document.getElementById('gen_msg').textContent = 'æ­£åœ¨ç™»å½•å¹¶ç”Ÿæˆä¼šè¯...';
      const j = await apiJSON('/api/session/verify', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone, code, password })
      });
      if (j.ok) {
        document.getElementById('acc_session').value = j.data.session_string;
        // è‡ªåŠ¨æ ‡è®°ç™»å½•ä½¿ç”¨çš„æ‰‹æœºå·ï¼Œé¿å…æ‰‹åŠ¨å¡«å†™é—æ¼
        document.getElementById('acc_phone').value = phone;
        document.getElementById('gen_msg').textContent = 'ç”ŸæˆæˆåŠŸï¼Œå·²è‡ªåŠ¨å¡«å…¥ä¸Šæ–¹ä¼šè¯æ¡†';
      } else {
        document.getElementById('gen_msg').textContent = 'ç”Ÿæˆå¤±è´¥: ' + j.error;
      }
    }

    async function loadAccounts() {
      const j = await apiJSON('/api/accounts');
      const div = document.getElementById('accounts');
      div.innerHTML = '';
      if (!j.ok) { div.textContent = 'åŠ è½½å¤±è´¥: ' + j.error; return; }
      const accs = j.data.accounts || [];
      for (const a of accs) {
        const el = document.createElement('div'); el.className = 'card';
        el.innerHTML = `
          <div class="row">
            <strong>${a.name}</strong> (#${a.id})
            <span style="color:#888; margin-left:8px;">${a.phone ? a.phone : 'æ— ç”µè¯'}</span>
            <label><input type="checkbox" ${a.is_enabled ? 'checked' : ''} onchange="toggleEnabled(${a.id}, this.checked)"> å¯ç”¨</label>
            <button onclick="deleteAccount(${a.id})" style="background:#e65c5c">åˆ é™¤è´¦å·</button>
          </div>
          <div class="row">
            <button onclick="testSession(${a.id})">æµ‹è¯•ä¼šè¯</button>
            <button onclick="refreshGroups(${a.id})">åˆ·æ–°ç¾¤ç»„</button>
            <button onclick="showGroups(${a.id})">æ˜¾ç¤ºç¾¤ç»„</button>
            <button onclick="showSelected(${a.id})">å·²å‹¾é€‰</button>
          </div>
          <div class="row">
            <button id="listener_btn_${a.id}" onclick="toggleListener(${a.id})" style="background:#2196f3">å¯åŠ¨ç›‘å¬</button>
            <div id="listener_status_${a.id}" class="status-indicator idle" style="display: none;">
              <div class="status-dot"></div>
              <span>ç›‘å¬çŠ¶æ€</span>
            </div>
            <button id="download_listener_${a.id}" onclick="downloadListenerUsernames(${a.id})" style="background:#4caf50; display: none;">ä¸‹è½½ç›‘å¬ç”¨æˆ·å</button>
          </div>
          <div class="row">
            <label>é€‰æ‹©é‡‡é›†å¤©æ•°</label>
            <input id="days_${a.id}" type="number" value="7" min="1" max="30" />
            <button id="collect_btn_${a.id}" onclick="startCollect(${a.id})">å¼€å§‹é‡‡é›†ï¼ˆä»…è¯¥è´¦å·ï¼‰</button>
            <div id="status_${a.id}" class="status-indicator idle" style="display: none;">
              <div class="status-dot"></div>
              <span>ç©ºé—²</span>
            </div>
          </div>
          <div id="progress_${a.id}" class="progress-container" style="display: none;">
            <div class="progress-bar-wrapper">
              <div class="progress-bar animated" style="width: 0%"></div>
            </div>
            <div class="progress-text">
              <span class="progress-percentage">0%</span>
              <span class="progress-details">
                <span class="current-group">å‡†å¤‡ä¸­...</span>
                <span class="eta" style="margin-left: 10px;">é¢„è®¡å‰©ä½™: --</span>
              </span>
            </div>
          </div>
          <div id="result_${a.id}"></div>
          <div class="row">
            <label>å¯¼å‡ºèŒƒå›´</label>
            <select id="range_${a.id}">
              <option value="today">today</option>
              <option value="yesterday">yesterday</option>
              <option value="3d">3d</option>
              <option value="7d" selected>7d</option>
            </select>
            <input id="chat_${a.id}" placeholder="å¯é€‰ chat_id" />
            <a id="download_${a.id}" href="#" onclick="downloadTxt(${a.id}); return false;">ä¸‹è½½ TXT</a>
          </div>
          <div id="groups_${a.id}" class="list"></div>
        `;
        div.appendChild(el);
      }
    }

    async function testSession(account_id) {
      const j = await apiJSON(`/api/accounts/${account_id}/test-session`, {method: 'POST'});
      alert(j.ok ? ('æˆæƒçŠ¶æ€: ' + j.data.authorized) : ('å¤±è´¥: ' + j.error));
    }

    async function refreshGroups(account_id) {
      const j = await apiJSON(`/api/accounts/${account_id}/refresh-groups`, {method: 'POST'});
      alert(j.ok ? ('åˆ·æ–°ç¾¤æ•°é‡: ' + j.data.count) : ('å¤±è´¥: ' + j.error));
    }

    async function showGroups(account_id) {
      const j = await apiJSON(`/api/accounts/${account_id}/groups`);
      const box = document.getElementById(`groups_${account_id}`);
      if (!j.ok) { box.textContent = 'åŠ è½½å¤±è´¥: ' + j.error; return; }
      const groups = j.data.groups || [];
      box.innerHTML = '';
      const ul = document.createElement('ul');
      for (const g of groups) {
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" value="${g.chat_id}"> [${g.chat_id}] ${g.title}</label>`;
        ul.appendChild(li);
      }
      box.appendChild(ul);
      const btn = document.createElement('button');
      btn.textContent = 'ä¿å­˜å‹¾é€‰';
      btn.onclick = async () => {
        const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(i => parseInt(i.value));
        const j2 = await apiJSON(`/api/accounts/${account_id}/select-groups`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({chat_ids: checked})
        });
        alert(j2.ok ? ('å·²ä¿å­˜: ' + j2.data.count) : ('å¤±è´¥: ' + j2.error));
      };
      box.appendChild(btn);
    }

    async function showSelected(account_id) {
      const j = await apiJSON(`/api/accounts/${account_id}/selected-groups`);
      if (!j.ok) { alert('å¤±è´¥: ' + j.error); return; }
      const selected = (j.data.selected || []).map(s => s.chat_id);
      const box = document.getElementById(`groups_${account_id}`);
      box.innerHTML = '<div class="row">å·²å‹¾é€‰ç¾¤èŠ: ' + (selected.length ? selected.join(', ') : 'æ— ') + '</div>';
    }

    async function startCollect(account_id) {
      const btn = document.getElementById(`collect_btn_${account_id}`);
      const status = document.getElementById(`status_${account_id}`);
      const progressDiv = document.getElementById(`progress_${account_id}`);
      const resultDiv = document.getElementById(`result_${account_id}`);
      
      // è®¾ç½®åŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.classList.add('loading-btn');
      btn.textContent = 'é‡‡é›†ä¸­...';
      
      // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨å’Œè¿›åº¦æ¡
      status.style.display = 'inline-flex';
      status.className = 'status-indicator collecting';
      status.querySelector('span').textContent = 'é‡‡é›†ä¸­';
      status.querySelector('.status-dot').classList.add('pulse');
      
      // æ˜¾ç¤ºå¹¶åˆå§‹åŒ–è¿›åº¦æ¡
      progressDiv.style.display = 'block';
      updateProgressBar(`progress_${account_id}`, 0, 'å‡†å¤‡ä¸­...', '--');
      
      // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
      resultDiv.innerHTML = '';
      
      try {
        const days = parseInt(document.getElementById(`days_${account_id}`).value) || 7;
        const j = await apiJSON('/api/collect', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({days, accounts: [account_id]})
        });
        
        if (j.ok) {
          // æ˜¾ç¤ºä»»åŠ¡å¯åŠ¨æˆåŠŸæ¶ˆæ¯
          showCollectionResult(resultDiv, {
            ok: true, 
            data: {message: "é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨åå°è¿è¡Œ..."}
          }, account_id);
          
          // å¼€å§‹è½®è¯¢è¿›åº¦
          startProgressPolling(account_id);
        } else {
          // æ˜¾ç¤ºé”™è¯¯
          showCollectionResult(resultDiv, j, account_id);
          
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          btn.disabled = false;
          btn.classList.remove('loading-btn');
          btn.textContent = 'å¼€å§‹é‡‡é›†ï¼ˆä»…è¯¥è´¦å·ï¼‰';
          
          // æ¢å¤çŠ¶æ€æŒ‡ç¤ºå™¨
          status.className = 'status-indicator idle';
          status.querySelector('span').textContent = 'ç©ºé—²';
          status.querySelector('.status-dot').classList.remove('pulse');
          
          // éšè—è¿›åº¦æ¡
          progressDiv.style.display = 'none';
        }
        
      } catch (error) {
        showCollectionResult(resultDiv, {ok: false, error: error.message}, account_id);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.classList.remove('loading-btn');
        btn.textContent = 'å¼€å§‹é‡‡é›†ï¼ˆä»…è¯¥è´¦å·ï¼‰';
        
        // æ¢å¤çŠ¶æ€æŒ‡ç¤ºå™¨
        status.className = 'status-indicator idle';
        status.querySelector('span').textContent = 'ç©ºé—²';
        status.querySelector('.status-dot').classList.remove('pulse');
        
        // éšè—è¿›åº¦æ¡
        progressDiv.style.display = 'none';
      }
    }

    function downloadTxt(account_id) {
      const range = document.getElementById(`range_${account_id}`).value;
      const chat = document.getElementById(`chat_${account_id}`).value.trim();
      const url = `/api/export/txt?range=${encodeURIComponent(range)}&account_id=${account_id}` + (chat ? `&chat_id=${encodeURIComponent(chat)}` : '');
      window.location.href = url;
    }

    function downloadListenerUsernames(account_id) {
      const url = `/api/export/listener-usernames/${account_id}`;
      window.location.href = url;
    }

    async function cleanupDatabase() {
      if (!confirm('ç¡®è®¤æ•´ç†æ•°æ®åº“ï¼Ÿè¿™å°†å»é™¤é‡å¤æ•°æ®å¹¶ä¼˜åŒ–@usernameæ ¼å¼ã€‚')) return;
      
      try {
        const response = await apiJSON('/api/database/cleanup', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        
        if (response.ok) {
          alert(`æ•°æ®åº“æ•´ç†å®Œæˆï¼\n${response.data.message}\nè¯¦æƒ…ï¼š${JSON.stringify(response.data.details, null, 2)}`);
        } else {
          alert('æ•´ç†å¤±è´¥: ' + response.error);
        }
      } catch (error) {
        alert('æ•´ç†å¤±è´¥: ' + error.message);
      }
    }

    async function downloadCleanedUsernames() {
      try {
        const response = await fetch('/api/export/cleaned-usernames', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          // è·å–æ–‡ä»¶å†…å®¹
          const blob = await response.blob();
          
          // ä»å“åº”å¤´è·å–æ–‡ä»¶å
          const contentDisposition = response.headers.get('Content-Disposition');
          let filename = 'cleaned_usernames.txt';
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename=(.+)/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }
          
          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          const errorText = await response.text();
          alert('ä¸‹è½½å¤±è´¥: ' + errorText);
        }
      } catch (error) {
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
      }
    }

    async function toggleEnabled(account_id, enabled) {
      const j = await apiJSON(`/api/accounts/${account_id}`, {
        method: 'PUT', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({is_enabled: enabled})
      });
      if (!j.ok) alert('æ›´æ–°å¤±è´¥: ' + j.error);
    }

    async function deleteAccount(account_id) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è´¦å·ï¼Ÿ')) return;
      const j = await apiJSON(`/api/accounts/${account_id}`, {method: 'DELETE'});
      alert(j.ok ? 'å·²åˆ é™¤' : ('åˆ é™¤å¤±è´¥: ' + j.error));
      await loadAccounts();
    }

    async function collectAllEnabled() {
      const btn = document.getElementById('collect_all_btn');
      const status = document.getElementById('status_all');
      const progressDiv = document.getElementById('progress_all');
      const resultDiv = document.getElementById('result_all');
      
      // è®¾ç½®åŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.classList.add('loading-btn');
      btn.textContent = 'é‡‡é›†ä¸­...';
      
      // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨å’Œè¿›åº¦æ¡
      status.style.display = 'inline-flex';
      status.className = 'status-indicator collecting';
      status.querySelector('span').textContent = 'é‡‡é›†ä¸­';
      status.querySelector('.status-dot').classList.add('pulse');
      
      // æ˜¾ç¤ºå¹¶åˆå§‹åŒ–è¿›åº¦æ¡
      progressDiv.style.display = 'block';
      updateProgressBar('progress_all', 0, 'å‡†å¤‡ä¸­...', '--');
      
      // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
      resultDiv.innerHTML = '';
      
      try {
        const days = parseInt(document.getElementById('days_all').value) || 7;
        const j = await apiJSON('/api/collect', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({days})
        });
        
        if (j.ok) {
          // æ˜¾ç¤ºä»»åŠ¡å¯åŠ¨æˆåŠŸæ¶ˆæ¯
          showCollectionResult(resultDiv, {
            ok: true, 
            data: {message: "é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨åå°è¿è¡Œ..."}
          }, 'all');
          
          // å¼€å§‹è½®è¯¢è¿›åº¦
          startProgressPolling('all');
        } else {
          // æ˜¾ç¤ºé”™è¯¯
          showCollectionResult(resultDiv, j, 'all');
          
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          btn.disabled = false;
          btn.classList.remove('loading-btn');
          btn.textContent = 'é‡‡é›†æ‰€æœ‰å¯ç”¨è´¦å·';
          
          // æ¢å¤çŠ¶æ€æŒ‡ç¤ºå™¨
          status.className = 'status-indicator idle';
          status.querySelector('span').textContent = 'ç©ºé—²';
          status.querySelector('.status-dot').classList.remove('pulse');
          
          // éšè—è¿›åº¦æ¡
          progressDiv.style.display = 'none';
        }
        
      } catch (error) {
        showCollectionResult(resultDiv, {ok: false, error: error.message}, 'all');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.classList.remove('loading-btn');
        btn.textContent = 'é‡‡é›†æ‰€æœ‰å¯ç”¨è´¦å·';
        
        // æ¢å¤çŠ¶æ€æŒ‡ç¤ºå™¨
        status.className = 'status-indicator idle';
        status.querySelector('span').textContent = 'ç©ºé—²';
        status.querySelector('.status-dot').classList.remove('pulse');
        
        // éšè—è¿›åº¦æ¡
        progressDiv.style.display = 'none';
      }
    }

    function downloadTxtAll() {
      const range = document.getElementById('range_all').value;
      const chat = document.getElementById('chat_all').value.trim();
      const url = `/api/export/txt?range=${encodeURIComponent(range)}` + (chat ? `&chat_id=${encodeURIComponent(chat)}` : '');
      window.location.href = url;
    }

    // æ˜¾ç¤ºé‡‡é›†ç»“æœçš„å‡½æ•°
    function showCollectionResult(container, response, accountId) {
      const isSuccess = response.ok;
      const panelClass = isSuccess ? 'result-panel' : 'result-panel error';
      
      let content = '';
      if (isSuccess) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¯åŠ¨æ¶ˆæ¯
        if (response.data.message) {
          content = `
            <div class="result-header">
              <span>ğŸš€ ä»»åŠ¡å¯åŠ¨</span>
              <span style="color: var(--muted); font-size: 12px;">${new Date().toLocaleString()}</span>
            </div>
            <div class="result-content">
              ${response.data.message}
            </div>
            <div class="result-content" style="margin-top: 8px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 4px;">
              ğŸ’¡ è¯·ç­‰å¾…è¿›åº¦æ›´æ–°ï¼Œé‡‡é›†å®Œæˆåä¼šæ˜¾ç¤ºè¯¦ç»†ç»“æœ
            </div>
          `;
        } else {
          // å¤„ç†é‡‡é›†å®Œæˆçš„ç»“æœ
          const results = response.data.results || {};
          const accountResults = accountId === 'all' ? results : {[accountId]: results[accountId]};
          
          // è®¡ç®—æ€»è®¡
          let totalUsers = 0, totalSpeaks = 0, totalGroups = 0;
          for (const [accId, result] of Object.entries(accountResults)) {
            if (result) {
              totalUsers += result.new_users || 0;
              totalSpeaks += result.new_speaks || 0;
              totalGroups += result.groups_processed || 0;
            }
          }
          
          content = `
            <div class="result-header">
              <span>âœ… é‡‡é›†å®Œæˆ</span>
              <span style="color: var(--muted); font-size: 12px;">${new Date().toLocaleString()}</span>
            </div>
            <div class="result-stats">
              <div class="stat-item">
                <div class="stat-value">${totalUsers}</div>
                <div class="stat-label">æ–°ç”¨æˆ·</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${totalSpeaks}</div>
                <div class="stat-label">æ–°æ¶ˆæ¯</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${totalGroups}</div>
                <div class="stat-label">å¤„ç†ç¾¤ç»„</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${Object.keys(accountResults).length}</div>
                <div class="stat-label">è´¦å·æ•°é‡</div>
              </div>
            </div>
          `;
          
          if (totalUsers === 0 && totalSpeaks === 0) {
            content += `
              <div class="result-content" style="margin-top: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">
                ğŸ’¡ æç¤ºï¼šæœªå‘ç°æ–°æ•°æ®ï¼Œå¯èƒ½æ˜¯å› ä¸ºé‡‡é›†æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ–°æ´»åŠ¨ã€‚å»ºè®®å¢åŠ é‡‡é›†å¤©æ•°æˆ–æ£€æŸ¥ç¾¤ç»„é€‰æ‹©ã€‚
              </div>
            `;
          }
          
          // ä¿å­˜åˆ°å†å²è®°å½•
          saveCollectionHistory({
            timestamp: new Date().toISOString(),
            accountId: accountId,
            success: true,
            totalUsers,
            totalSpeaks,
            totalGroups,
            accountCount: Object.keys(accountResults).length
          });
        }
      } else {
        content = `
          <div class="result-header">
            <span>âŒ é‡‡é›†å¤±è´¥</span>
            <span style="color: var(--muted); font-size: 12px;">${new Date().toLocaleString()}</span>
          </div>
          <div class="result-content">
            é”™è¯¯ä¿¡æ¯ï¼š${response.error || 'æœªçŸ¥é”™è¯¯'}
          </div>
          <div class="result-content" style="margin-top: 8px; padding: 8px; background: rgba(230, 92, 92, 0.1); border-radius: 4px;">
            ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ã€è´¦å·çŠ¶æ€æˆ–è”ç³»ç®¡ç†å‘˜
          </div>
        `;
        
        // ä¿å­˜å¤±è´¥è®°å½•åˆ°å†å²
        saveCollectionHistory({
          timestamp: new Date().toISOString(),
          accountId: accountId,
          success: false,
          error: response.error || 'æœªçŸ¥é”™è¯¯'
        });
      }
      
      container.innerHTML = `<div class="${panelClass}">${content}</div>`;
      
      // 5ç§’åè‡ªåŠ¨æ·¡å‡ºï¼ˆä½†ä¸åˆ é™¤ï¼‰
      setTimeout(() => {
        const panel = container.querySelector('.result-panel');
        if (panel) {
          panel.style.opacity = '0.7';
        }
      }, 5000);
    }

    // é‡‡é›†å†å²è®°å½•ç®¡ç†
    function saveCollectionHistory(record) {
      let history = JSON.parse(localStorage.getItem('collection_history') || '[]');
      history.unshift(record); // æ·»åŠ åˆ°å¼€å¤´
      
      // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
      if (history.length > 50) {
        history = history.slice(0, 50);
      }
      
      localStorage.setItem('collection_history', JSON.stringify(history));
    }

    function loadCollectionHistory() {
      const history = JSON.parse(localStorage.getItem('collection_history') || '[]');
      const container = document.getElementById('collection_history');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="result-content">æš‚æ— é‡‡é›†å†å²è®°å½•</div>';
        return;
      }
      
      let content = '<div class="list"><ul>';
      for (const record of history.slice(0, 10)) { // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
        const time = new Date(record.timestamp).toLocaleString();
        const accountText = record.accountId === 'all' ? 'æ‰€æœ‰è´¦å·' : `è´¦å· #${record.accountId}`;
        
        if (record.success) {
          content += `
            <li>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: #4caf50;">âœ… ${accountText}</strong>
                  <span style="color: var(--muted); font-size: 12px; margin-left: 8px;">${time}</span>
                </div>
                <div style="font-size: 12px; color: var(--muted);">
                  ç”¨æˆ·: ${record.totalUsers} | æ¶ˆæ¯: ${record.totalSpeaks} | ç¾¤ç»„: ${record.totalGroups}
                </div>
              </div>
            </li>
          `;
        } else {
          content += `
            <li>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: #e65c5c;">âŒ ${accountText}</strong>
                  <span style="color: var(--muted); font-size: 12px; margin-left: 8px;">${time}</span>
                </div>
                <div style="font-size: 12px; color: #e65c5c;">
                  ${record.error}
                </div>
              </div>
            </li>
          `;
        }
      }
      content += '</ul></div>';
      
      if (history.length > 10) {
        content += `<div class="result-content" style="text-align: center; margin-top: 8px;">æ˜¾ç¤ºæœ€è¿‘ 10 æ¡ï¼Œå…± ${history.length} æ¡è®°å½•</div>`;
      }
      
      container.innerHTML = content;
    }

    function clearCollectionHistory() {
      if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰é‡‡é›†å†å²è®°å½•ï¼Ÿ')) {
        localStorage.removeItem('collection_history');
        loadCollectionHistory();
      }
    }

    // è¿›åº¦æ¡æ§åˆ¶å‡½æ•°
    function updateProgressBar(progressId, percentage, currentGroup, eta) {
      const progressContainer = document.getElementById(progressId);
      if (!progressContainer) return;
      
      const progressBar = progressContainer.querySelector('.progress-bar');
      const percentageSpan = progressContainer.querySelector('.progress-percentage');
      const currentGroupSpan = progressContainer.querySelector('.current-group');
      const etaSpan = progressContainer.querySelector('.eta');
      
      if (progressBar) progressBar.style.width = `${percentage}%`;
      if (percentageSpan) percentageSpan.textContent = `${percentage}%`;
      if (currentGroupSpan) currentGroupSpan.textContent = currentGroup;
      if (etaSpan) etaSpan.textContent = `é¢„è®¡å‰©ä½™: ${eta}`;
    }

    // è¿›åº¦è½®è¯¢
    const progressPollers = new Map();
    
    function startProgressPolling(accountId) {
      // åœæ­¢ä¹‹å‰çš„è½®è¯¢
      if (progressPollers.has(accountId)) {
        clearInterval(progressPollers.get(accountId));
      }
      
      const progressId = accountId === 'all' ? 'progress_all' : `progress_${accountId}`;
      let pollCount = 0;
      const maxPolls = 600; // æœ€å¤šè½®è¯¢10åˆ†é’Ÿ (600 * 1000ms)
      
      const poller = setInterval(async () => {
        pollCount++;
        
        try {
          // è°ƒç”¨å®é™…çš„APIè·å–è¿›åº¦
          const response = await apiJSON(`/api/progress/${accountId}`);
          
          if (response.ok && response.data) {
            const progress = response.data;
            const percentage = progress.percentage || 0;
            const groupName = progress.group_name || 'å‡†å¤‡ä¸­...';
            
            // è®¡ç®—é¢„è®¡å‰©ä½™æ—¶é—´
            let eta = '--';
            if (percentage > 0 && percentage < 100) {
              const remainingGroups = progress.total_groups - progress.current_group;
              const avgTimePerGroup = pollCount * 1000 / Math.max(progress.current_group, 1); // æ¯«ç§’
              const remainingMs = remainingGroups * avgTimePerGroup;
              const remainingMinutes = Math.ceil(remainingMs / 60000);
              eta = `${remainingMinutes} åˆ†é’Ÿ`;
            } else if (percentage >= 100) {
              eta = '0 åˆ†é’Ÿ';
            }
            
            updateProgressBar(progressId, percentage, groupName, eta);
            
            // å¦‚æœé‡‡é›†å®Œæˆï¼Œåœæ­¢è½®è¯¢
            if (progress.status === 'completed' || percentage >= 100) {
              clearInterval(poller);
              progressPollers.delete(accountId);
              
              // å®Œæˆæ—¶è®¾ç½®100%å¹¶å»¶è¿Ÿéšè—
              updateProgressBar(progressId, 100, 'é‡‡é›†å®Œæˆ', '0 åˆ†é’Ÿ');
              setTimeout(() => {
                const progressDiv = document.getElementById(progressId);
                if (progressDiv) progressDiv.style.display = 'none';
              }, 3000);
            }
          } else {
            // APIè¿”å›é”™è¯¯æˆ–æ— æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿè¿›åº¦
            const mockProgress = Math.min(pollCount * 1, 95);
            const mockGroup = `ç¾¤ç»„ ${Math.floor(pollCount / 10) + 1}`;
            const mockEta = Math.max(0, Math.floor((100 - mockProgress) / 2)) + ' åˆ†é’Ÿ';
            
            updateProgressBar(progressId, mockProgress, mockGroup, mockEta);
            
            if (pollCount >= maxPolls || mockProgress >= 95) {
              clearInterval(poller);
              progressPollers.delete(accountId);
              updateProgressBar(progressId, 100, 'é‡‡é›†å®Œæˆ', '0 åˆ†é’Ÿ');
              setTimeout(() => {
                const progressDiv = document.getElementById(progressId);
                if (progressDiv) progressDiv.style.display = 'none';
              }, 3000);
            }
          }
        } catch (error) {
          console.error('Progress polling error:', error);
          
          // å‘ç”Ÿé”™è¯¯æ—¶åœæ­¢è½®è¯¢
          clearInterval(poller);
          progressPollers.delete(accountId);
        }
      }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
      
      progressPollers.set(accountId, poller);
    }

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const result = await response.json();
        
        if (result.ok) {
          const stats = result.data;
          let html = `
            <div class="row">
              <strong>æ€»ä½“ç»Ÿè®¡</strong>
            </div>
            <div class="row">
              <span>æ€»ç”¨æˆ·æ•°: <strong>${stats.total_users}</strong></span>
              <span>æœ‰ç”¨æˆ·åçš„ç”¨æˆ·: <strong>${stats.users_with_username}</strong></span>
              <span>æ€»å‘è¨€æ•°: <strong>${stats.total_speaks}</strong></span>
            </div>
          `;
          
          if (stats.account_stats && stats.account_stats.length > 0) {
            html += `
              <div class="row" style="margin-top: 15px;">
                <strong>æŒ‰è´¦å·ç»Ÿè®¡</strong>
              </div>
            `;
            stats.account_stats.forEach(acc => {
              html += `
                <div class="row">
                  <span>${acc.account_name}: ${acc.user_count} ç”¨æˆ·, ${acc.speak_count} å‘è¨€</span>
                </div>
              `;
            });
          }
          
          if (stats.recent_users && stats.recent_users.length > 0) {
            html += `
              <div class="row" style="margin-top: 15px;">
                <strong>æœ€è¿‘é‡‡é›†çš„ç”¨æˆ· (æœ€æ–°10ä¸ª)</strong>
              </div>
            `;
            stats.recent_users.forEach(user => {
              const displayName = user.first_name || user.last_name ? 
                `${user.first_name || ''} ${user.last_name || ''}`.trim() : 
                'æ— æ˜µç§°';
              const date = new Date(user.created_at).toLocaleString('zh-CN');
              html += `
                <div class="row" style="font-size: 0.9em; color: #666;">
                  <span>@${user.username} (${displayName}) - ${date}</span>
                </div>
              `;
            });
          }
          
          document.getElementById('stats_content').innerHTML = html;
        } else {
          document.getElementById('stats_content').innerHTML = `<div class="row" style="color: red;">åŠ è½½ç»Ÿè®¡å¤±è´¥: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('Load stats error:', error);
        document.getElementById('stats_content').innerHTML = `<div class="row" style="color: red;">åŠ è½½ç»Ÿè®¡æ—¶å‡ºé”™</div>`;
      }
    }

    // ç›‘å¬å™¨ç›¸å…³å‡½æ•°
    async function toggleListener(accountId) {
      const btn = document.getElementById(`listener_btn_${accountId}`);
      const status = document.getElementById(`listener_status_${accountId}`);
      
      const downloadBtn = document.getElementById(`download_listener_${accountId}`);
      
      try {
        // å…ˆè·å–å½“å‰çŠ¶æ€
        const statusResponse = await fetch(`/api/accounts/${accountId}/listener-status`);
        const statusResult = await statusResponse.json();
        
        if (!statusResult.ok) {
          alert(`è·å–ç›‘å¬å™¨çŠ¶æ€å¤±è´¥: ${statusResult.error}`);
          return;
        }
        
        const isRunning = statusResult.data.is_running;
        
        if (isRunning) {
          // åœæ­¢ç›‘å¬
          btn.textContent = 'åœæ­¢ä¸­...';
          btn.disabled = true;
          
          const response = await fetch(`/api/accounts/${accountId}/stop-listener`, {
            method: 'POST'
          });
          const result = await response.json();
          
          if (result.ok) {
            btn.textContent = 'å¯åŠ¨ç›‘å¬';
            btn.style.background = '#2196f3';
            status.style.display = 'none';
            downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½æŒ‰é’®
            alert('ç›‘å¬å™¨å·²åœæ­¢');
          } else {
            alert(`åœæ­¢ç›‘å¬å¤±è´¥: ${result.error}`);
          }
        } else {
          // å¯åŠ¨ç›‘å¬
          btn.textContent = 'å¯åŠ¨ä¸­...';
          btn.disabled = true;
          
          const response = await fetch(`/api/accounts/${accountId}/start-listener`, {
            method: 'POST'
          });
          const result = await response.json();
          
          if (result.ok) {
            btn.textContent = 'åœæ­¢ç›‘å¬';
            btn.style.background = '#f44336';
            status.style.display = 'inline-flex';
            status.className = 'status-indicator running';
            status.querySelector('span').textContent = 'ç›‘å¬ä¸­';
            downloadBtn.style.display = 'inline-block'; // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            alert('ç›‘å¬å™¨å·²å¯åŠ¨');
            
            // å¼€å§‹è½®è¯¢ç›‘å¬å™¨çŠ¶æ€
            startListenerStatusPolling(accountId);
          } else {
            alert(`å¯åŠ¨ç›‘å¬å¤±è´¥: ${result.error}`);
          }
        }
      } catch (error) {
        console.error('Toggle listener error:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      } finally {
        btn.disabled = false;
      }
    }

    // ç›‘å¬å™¨çŠ¶æ€è½®è¯¢
    const listenerPollers = new Map();
    
    function startListenerStatusPolling(accountId) {
      // æ¸…é™¤å·²å­˜åœ¨çš„è½®è¯¢å™¨
      if (listenerPollers.has(accountId)) {
        clearInterval(listenerPollers.get(accountId));
      }
      
      const poller = setInterval(async () => {
        try {
          const response = await fetch(`/api/accounts/${accountId}/listener-status`);
          const result = await response.json();
          
          if (result.ok) {
            const status = result.data;
            const statusDiv = document.getElementById(`listener_status_${accountId}`);
            const btn = document.getElementById(`listener_btn_${accountId}`);
            const downloadBtn = document.getElementById(`download_listener_${accountId}`);
            
            if (status.is_running) {
              statusDiv.style.display = 'inline-flex';
              statusDiv.className = 'status-indicator running';
              statusDiv.querySelector('span').textContent = `ç›‘å¬ä¸­ (${status.messages_processed} æ¶ˆæ¯)`;
              btn.textContent = 'åœæ­¢ç›‘å¬';
              btn.style.background = '#f44336';
              downloadBtn.style.display = 'inline-block'; // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            } else {
              statusDiv.style.display = 'none';
              btn.textContent = 'å¯åŠ¨ç›‘å¬';
              btn.style.background = '#2196f3';
              downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½æŒ‰é’®
              clearInterval(poller);
              listenerPollers.delete(accountId);
            }
          }
        } catch (error) {
          console.error('Listener status polling error:', error);
        }
      }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
      
      listenerPollers.set(accountId, poller);
    }

    // åˆå§‹åŒ–ç›‘å¬å™¨çŠ¶æ€
    async function initListenerStatus() {
      try {
        const response = await fetch('/api/listeners/status');
        const result = await response.json();
        
        if (result.ok) {
          const allStatus = result.data;
          
          Object.keys(allStatus).forEach(accountId => {
            const status = allStatus[accountId];
            const btn = document.getElementById(`listener_btn_${accountId}`);
            const statusDiv = document.getElementById(`listener_status_${accountId}`);
            
            const downloadBtn = document.getElementById(`download_listener_${accountId}`);
            
            if (btn && statusDiv) {
              if (status.is_running) {
                btn.textContent = 'åœæ­¢ç›‘å¬';
                btn.style.background = '#f44336';
                statusDiv.style.display = 'inline-flex';
                statusDiv.className = 'status-indicator running';
                statusDiv.querySelector('span').textContent = `ç›‘å¬ä¸­ (${status.messages_processed} æ¶ˆæ¯)`;
                if (downloadBtn) downloadBtn.style.display = 'inline-block'; // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                startListenerStatusPolling(parseInt(accountId));
              } else {
                btn.textContent = 'å¯åŠ¨ç›‘å¬';
                btn.style.background = '#2196f3';
                statusDiv.style.display = 'none';
                if (downloadBtn) downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½æŒ‰é’®
              }
            }
          });
        }
      } catch (error) {
        console.error('Init listener status error:', error);
      }
    }

    // è®¤è¯ç›¸å…³åŠŸèƒ½
    let authToken = localStorage.getItem('authToken');

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuthStatus() {
      if (authToken) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        return true;
      } else {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('main-container').style.display = 'none';
        return false;
      }
    }

    // ç™»å½•å¤„ç†
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        if (response.ok) {
          const data = await response.json();
          authToken = data.access_token;
          localStorage.setItem('authToken', authToken);
          checkAuthStatus();
          loadAccounts();
          initListenerStatus();
          loadCollectionHistory();
          loadStats();
          errorDiv.style.display = 'none';
        } else {
          const errorData = await response.json();
          errorDiv.textContent = errorData.detail || 'ç™»å½•å¤±è´¥';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
        errorDiv.style.display = 'block';
      }
    });

    // é€€å‡ºç™»å½•
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      authToken = null;
      checkAuthStatus();
    });

    // ä¿®æ”¹æ‰€æœ‰APIè¯·æ±‚ä»¥åŒ…å«è®¤è¯å¤´
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      if (authToken && url.startsWith('/api/') && !url.includes('/api/login')) {
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${authToken}`
        };
      }
      return originalFetch(url, options).then(response => {
        if (response.status === 401) {
          localStorage.removeItem('authToken');
          authToken = null;
          checkAuthStatus();
        }
        return response;
      });
    };

    window.addEventListener('load', () => {
      if (checkAuthStatus()) {
        loadAccounts();
        initListenerStatus();
        loadCollectionHistory();
        loadStats(); // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç»Ÿè®¡
      }
    });
  </script>
  </div> <!-- é—­åˆä¸»ç•Œé¢å®¹å™¨ -->
</body>
</html>